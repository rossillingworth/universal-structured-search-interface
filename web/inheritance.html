<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script src="js/lodash.compat.js"></script>
</head>
<body>

<h1>Testing JS inheritance POC</h1>

<script src="js/ExceptionExtensions.js"></script>
<script src="js/JS.js"></script>

<script>

    // TODO - share prototypes
    // TODO - NEED an extend function that only takes if hasOwnProperty==true


    // JS
    // Constructor.prototype -> properties & methods added to instances of Object created with new Constructor



    var CLASS = {
        // collection of constructor functions
        constructors:{},
        overrides:{},
        mixins:{},
        // create object
        // create extends hierarchy - heirarchy of prototypes
        // ?? create every time?
        // ?? reuse previous prototypes
        register:function(json){

            var config = json.specification;

            // hidden config, allows override on underlying prototype
            var underlyingPrototype = config.underlyingPrototype || Object.prototype;
            var allowParentConstructor = !!config.allowParentConstructor;

            // get base class constructor
            var baseName = config.extends;
            var baseConstructor = JS.OBJECT.getProperty(window,baseName);
            EXCEPTION.when(!!baseName && !(!!baseConstructor),"No base instance of %s",baseName);

            // create constructor
            function PROTOTYPE(){
                console.log("Inheriting from " + this + " to " + config.name);
            };

            function CONSTRUCTOR(){
                console.log("Constructor for " + config.name);
                // TODO - should this be possible to override in the config
                // !!config.constructor && config.constructor.apply(this,[].slice.apply(arguments));
                // allowParentConstructor && baseConstructor.prototype.constructor.apply(this,[].slice.apply(arguments));
                // TODO - should we call init from here?
                // this.init.apply(this,[].slice.apply(arguments));
            };

            // assign (base prototype or Object.prototype) to our intermediary prototype
            // inherit baseConstructor prototype without creating an instance on baseConstructor
            // this is also done to avoid polluting the baseConstructor.prototype
            PROTOTYPE.prototype = baseConstructor ? baseConstructor.prototype : underlyingPrototype;
            CONSTRUCTOR.prototype = new PROTOTYPE();
            CONSTRUCTOR.prototype.constructor = CONSTRUCTOR;
            // TODO - assign _super? - already available with prototype
            // TODO - assign _superConstructor?

            // decorate constructor with specified mixins
            if(config.mixins && config.mixins.length > 0){
                for(var i in config.mixins){
                    var mixinName = config.mixins[i];
                    // get mixin from global scope reference
                    var mixin = JS.OBJECT.getProperty(window,mixinName);
                    EXCEPTION.when(!mixin,"No instance of mixin found:  %s",mixinName);
                    // convert constructor to object if need to
                    _.isFunction(mixin) && (mixin = new mixin());
                    _.extend(CONSTRUCTOR.prototype,mixin);
                }
            }

            // implement overrides
            var overrides = CLASS.overrides[config.name];
            if(!!overrides){
                for(var i in overrides){
                    _.extend(CONSTRUCTOR.prototype,overrides[i]);
                }
            }

            // now add all other config properties
            _.extend(CONSTRUCTOR.prototype,json);

            // push CONSTRUCTOR to global namespace
            JS.OBJECT.setProperty(window,config.name,CONSTRUCTOR);
        },

        new:function(typeName,jsonConfig){
            var o = new CLASS.constructors[typeName]();
            !!o.init &&  o.init(jsonConfig);
            return o;
        },
        /**
         * Used to extend/modify functionality of any component
         * without touching the source code.
         * ie: temporary
         *
         * @param name
         * @param jsonConfig
         */
        override:function(name,jsonConfig){
            // ensure named override container exists
            !CLASS.overrides[name] && (CLASS.overrides[name] = []);
            CLASS.overrides[name].push(jsonConfig);
        }
    };




    //###################################################

    CLASS.override("ross.Base",{
        myVar:999,
        getVar:function(){
            console.log("getting myVar: " + this.myVar);
            return this.myVar;
        }
        ,setVar:function(val){
            this.myVar = val;
        }
    });

    var mixins = {
        test1:{
            testFunc1:function testFunc1(){console.log("testFunc1");}
        },
        test2:function(){
            this.testFunc2 = function testFunc2(){console.log("testFunc2");};
            function testFunc3(){console.log("testFunc3");};
        }
    };

    // TODO - put config into sub object is JSON
    CLASS.register({
        specification:{
            name:"ross.Base"
            ,extends:""
            ,mixins:["mixins.test1","mixins.test2"]
        }
        ,myVarXXX:0
        ,init:function(val){
            console.log("init base");
            this.myVarXXX = val;
        }
        ,func1:function (){
            console.log("func1");
        }
    });

    CLASS.register({
        specification:{
            name:"ross.Extend1"
            ,extends:"ross.Base"
        }
        ,init:function(){
            console.log("init extend1");
        }
        ,func3:function(){
            console.log("func3");
        }
    });
//
//    CLASS.register({
//        specification:{
//            name:"extend2"
//            ,extends:"base"
//            ,extendWith:[]
//        }
//        ,init:function(){
//            console.log("__proto__",this.__proto__);
//            debugger;
////            this.__proto__.__proto__.init(777);
//            this.prototype.prototype.init(777);
//            // TODO - this is failing
//            var p = this.__proto__;
//            while(!p.name=="base"){
//                p = p.__proto__;
//            }
//
//            console.log("init extend2");
//            console.log(this.myVarXXX);
//        }
//    });

//    var b = CLASS.new("base",{});
//    console.log(b.getVar());
//    b.setVar(666);

//    var bb = new CLASS.constructors.base()

    var bbb = new ross.Base();
    bbb.func1();
    console.log(bbb.getVar());
    bbb.setVar(111);

    var ee = new ross.Extend1();
    ee.func1();
    ee.func3();
    console.log(ee.getVar());
    ee.setVar(111);

//    var e = CLASS.new("extend1",{});
//    console.log(e.getVar())
//
//    console.log(b.getVar());
//
//    var e2 = CLASS.new("extend2",{});

    // TODO - PROTOTYPE is SHARED

</script>

</body>
</html>